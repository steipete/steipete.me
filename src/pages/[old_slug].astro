---
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  return posts.map(post => {
    // For files in year folders like 2020/file.md, the slug part after the year is what we want
    // For other files like a-new-beginning.md, use the full slug
    const slugParts = post.slug.split('/');
    const oldSlug = slugParts.length > 1 ? slugParts[1] : post.slug;

    return {
      params: { old_slug: oldSlug },
      props: { post }
    };
  });
}

const { old_slug } = Astro.params;

// Server-side redirect to the canonical URL
return Astro.redirect(`/blog/${old_slug}/`, 301);
---