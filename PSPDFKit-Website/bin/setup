#!/usr/bin/env bash

set -eu

### CONFIGURATION ###

yarn_version="1.9.4"
bundler_version="2.0.1"

asdf_dir="${ASDF_DIR:-$HOME/.asdf}"
required_asdf_plugins=("ruby" "nodejs")

middleman_command="bundle exec middleman server"

### SET UP ASDF ###

if ! command -v asdf >/dev/null; then
    asdf_install_url="https://asdf-vm.github.io/asdf/#/core-manage-asdf-vm?id=install-asdf-vm"
    echo "Please install asdf first: $asdf_install_url"
    exit 1
fi

if ! command -v gpg >/dev/null; then
    echo "Please install GPG first (needed to install nodejs versions): brew install gpg"
    exit 2
fi

for asdf_plugin in "${required_asdf_plugins[@]}"; do
    if ! asdf plugin-list | grep -wq "$asdf_plugin"; then
      asdf plugin-add "$asdf_plugin"

      if [ "$asdf_plugin" = "nodejs" ]; then
        # For instructions on how to set up the GPG keyring for nodejs installs see: https://github.com/asdf-vm/asdf-nodejs#using-a-dedicated-openpgp-keyring
        export GNUPGHOME="$asdf_dir/keyrings/nodejs"
        # Continue loop if keyring already exists.
        ! test -d "$GNUPGHOME" || continue

        mkdir -p "$GNUPGHOME"
        chmod 0700 "$GNUPGHOME"
        "$asdf_dir/plugins/nodejs/bin/import-release-team-keyring"
      fi
    fi
done

### INSTALL DEPENDENCIES ###

asdf install

# Install specified Bundler version if it isn't already installed.
bundle -v | grep -wq "$bundler_version" || (gem install bundler -v "$bundler_version" --no-document; asdf reshim ruby)
bundle install

# Install specified Yarn version if it isn't already installed.
yarn -v | grep -wq "$yarn_version" || (npm install -g "yarn@$yarn_version"; asdf reshim nodejs)
yarn install

### REPORT SUCCESS ###

echo "Setup finished"
echo "You can start middleman with '$middleman_command' now"

exit 0
